<!DOCTYPE html>
<html lang="lv" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Latgales ZoodƒÅrzs</title>
    <link rel="stylesheet" href="/style.css" />
    <style>
        :root { --primary: #4CAF50; --primary-dark: #388E3C; --bg: #f5f5f5; --bg-alt: #ffffff; --text: #333333; --text-light: #666666; --border: #dddddd; }
        [data-theme="dark"] { --primary: #66BB6A; --primary-dark: #558B2F; --bg: #121212; --bg-alt: #1e1e1e; --text: #969696; --text-light: #bbbbbb; --border: #333333; }
        body { padding: 0; margin: 0; padding-bottom: 160px; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); box-sizing: border-box; }
        .container { max-width: 900px !important; margin: 0 auto !important; background: var(--bg-alt); min-height: 100vh; box-shadow: 0 0 30px rgba(0,0,0,0.15); border-radius: 0; position: relative; }
        .header { z-index: 999; padding: 20px 30px; background: var(--primary); color: white; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; border-radius: 0; }
        .header h1 { font-size: 2rem; margin: 0; flex: 1; text-align: center; margin-left: -60px; font-weight: 700; }
        .theme-toggle { position: relative; display: inline-block; width: 56px; height: 30px; }
        .theme-toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ddd; transition: .4s; border-radius: 34px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
        [data-theme="dark"] .slider { background-color: #444; }
        [data-theme="dark"] input:checked + .slider { background-color: #444; }
        .slider:after { display: none; }
        .content { padding: 20px; padding-top: 100px !important; }
        #mobile-date { margin: 0 0 30px; font-size: 1.8rem; font-weight: bold; color: var(--primary-dark); text-align: center; }
        .search-wrapper { position: fixed; top: 0; left: 0; right: 0; background: var(--bg); padding: 20px; z-index: 998; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border-bottom: 1px solid var(--border); }
        .search-wrapper #taskSearch { width: 100%; max-width: 700px; margin: 0 auto; display: block; padding: 18px 24px; border: 3px solid var(--primary); border-radius: 20px; font-size: 1.3rem; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        /* ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà PERFEKTI CENTRƒíTS SEARCH DROPDOWN ‚Äì NEAPGRIE≈ΩAS, SKAISTS VISOS EKRƒÄNOS ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà */
        #taskResults {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: calc(90% - 6px); /* kompensƒì border */
            max-width: calc(700px - 6px);
            margin: 0 auto;
            background: white;
            border: 3px solid var(--primary);
            border-top: none;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 12px 35px rgba(0,0,0,0.25);
            max-height: 65vh;
            overflow-y: auto;
            z-index: 999;
            display: none;
            box-sizing: border-box;
        }
        [data-theme="dark"] #taskResults {
            background: #1e1e1e;
            border-color: var(--primary);
        }

        .search-result-item {
            padding: 18px 24px;
            cursor: pointer;
            transition: all 0.25s ease;
            border-bottom: 1px solid #eee;
            font-size: 1.15rem;
            text-align: center;
            font-weight: 500;
        }
        [data-theme="dark"] .search-result-item {
            border-bottom: 1px solid #333;
            color: #ddd;
        }
        .search-result-item:hover {
            background: var(--primary);
            color: white !important;
            font-weight: bold;
            transform: scale(1.02);
        }
        .search-result-item:last-child {
            border-bottom: none;
            border-radius: 0 0 17px 17px;
        }
        .search-result-item:first-child {
            border-top: 1px solid transparent; /* lai hover nelec */
        }
        .no-results {
            padding: 28px 20px;
            text-align: center;
            color: #999;
            font-style: italic;
            font-size: 1.1rem;
        }
        /* ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà BEIGAS SEARCH FIX ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà */

        .animal-icon { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 6px solid var(--primary); box-shadow: 0 8px 25px rgba(0,0,0,0.2); margin: 0 auto 16px; display: block; background: var(--bg-alt); }
        .animal-icon.fallback { background: linear-gradient(135deg, #2196F3, #21CBF3); display: flex; align-items: center; justify-content: center; font-size: 3rem; color: white; }
        #mobile-tasks { max-width: 900px; margin: 0 auto; padding: 0 20px; }
        .task-card { background: var(--bg-alt); border-radius: 24px; padding: 30px; margin: 24px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-left: 8px solid var(--primary); transition: all 0.3s ease; text-align: center; position: relative; overflow: hidden; }
        .task-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 8px; background: linear-gradient(90deg, var(--primary), var(--primary-dark)); border-radius: 24px 24px 0 0; }
        .task-card.selected { border-left: 10px solid var(--primary-dark); transform: translateY(-8px); box-shadow: 0 20px 50px rgba(0,0,0,0.25); }
        .task-card.completed { opacity: 0.8; background: #f9f9f9; }
        [data-theme="dark"] .task-card.completed { background: #252525; }
        .task-card h4 { margin: 16px 0; font-size: 1.6rem; color: var(--primary-dark); font-weight: 700; }
        .task-actions { display: flex; gap: 16px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
        .btn-small { padding: 16px 24px; font-size: 1.3rem; min-width: 60px; border: 4px solid #4CAF50; border-radius: 20px; box-shadow: 0 6px 20px rgba(76,175,80,0.4); background: white; color: #1B5E20; font-weight: bold; cursor: pointer; transition: all 0.25s ease; }
        .btn-small.marked { background: #4CAF50 !important; color: white !important; border-color: #388E3C !important; box-shadow: 0 12px 35px rgba(76,175,80,0.8) !important; transform: scale(1.2); animation: pulse 0.4s ease; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1.2); } }
        .floating-actions { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-alt); padding: 16px 20px; box-shadow: 0 -8px 30px rgba(0,0,0,0.2); border-top: 1px solid var(--border); display: flex; gap: 12px; justify-content: center; align-items: center; flex-wrap: wrap; z-index: 999; bottom: env(safe-area-inset-bottom, 0px); padding-bottom: calc(20px + env(safe-area-inset-bottom)); backdrop-filter: blur(10px); }
        .floating-actions button { flex: 1; min-width: 120px; max-width: 220px; padding: 16px 20px; font-size: 1.1rem; font-weight: bold; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(0,0,0,0.15); border: none; color: white; position: relative; overflow: hidden; }
        .btn-complete { background: #4CAF50; }
        .btn-cancel { background: #f44336; }
        #saveBatchBtn { background: #ff9800; }
        .btn-reply { background: #9C27B0; }
        .btn-activity { background: #2196F3; }
        .floating-actions button:disabled { background: #999 !important; cursor: not-allowed; transform: none !important; box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important; }
        .floating-actions button:not(:disabled):hover { transform: translateY(-4px) scale(1.05); box-shadow: 0 12px 30px rgba(0,0,0,0.25); }
        .floating-actions button:not(:disabled):active { transform: translateY(2px) scale(0.98); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .floating-actions button::after { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255,255,255,0.3); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.6s ease, height 0.6s ease; }
        .floating-actions button:active::after { width: 300px; height: 300px; }
        @media (max-width: 768px) { .floating-actions { padding: 12px 16px; gap: 10px; } .floating-actions button { min-width: 100px; padding: 14px 16px; font-size: 1rem; } }
        @media (min-width: 769px) { .floating-actions { justify-content: center; gap: 20px; padding: 20px 40px; } .floating-actions button { min-width: 160px; padding: 18px 32px; font-size: 1.2rem; } }
        #animalModal .modal-content { background: var(--bg-alt); margin: 5% auto; padding: 24px; width: 90%; max-width: 900px; border-radius: 20px; max-height: 90vh; overflow-y: auto; box-shadow: 0 15px 40px rgba(0,0,0,0.3); text-align: left; }
        .loading, .error { text-align: center; padding: 60px 20px; font-size: 1.2rem; }
        .error { color: #d32f2f; }
        @media (max-width: 768px) { .container { max-width: 100% !important; border-radius: 0; } .task-card { padding: 18px; margin: 12px 8px; } }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ZOO</h1>
        <div class="user-info">
            <span id="mobile-username">IelƒÅdƒìjas...</span>
            <button onclick="logout()" class="btn-small">Iziet</button>
            <label class="theme-toggle">
                <input type="checkbox" id="themeCheckbox" onclick="toggleTheme()">
                <span class="slider"></span>
            </label>
        </div>
    </div>
    <div class="content">
        <h2 id="mobile-date">≈†odien</h2>
        <div class="search-wrapper">
            <input type="text" id="taskSearch" placeholder="üîç Meklƒìt pƒìc b≈´ra/sprosta vai nosaukuma..." onkeyup="filterTasks()" autocomplete="off" />
            <div id="taskResults"></div>
        </div>
        <div id="addAnimalContainer" style="display:none; margin: 10px 0;">
            <button class="btn btn-primary" onclick="window.location.href='add-animal.html'" style="background:#2196F3; padding:12px 20px; font-size:1.1rem;"> ‚ûï Pievienot jaunu dzƒ´vnieku </button>
        </div>
        <div id="mobile-tasks">
            <div class="loading">IelƒÅdƒì uzdevumus...</div>
        </div>
    </div>
</div>

<div class="floating-actions">
    <button class="btn btn-complete" id="completeBtn" onclick="completeSelected()" disabled>ApstiprinƒÅt</button>
    <button class="btn btn-cancel" id="cancelBtn" onclick="cancelSelected()" disabled>Atcelt</button>
    <button class="btn" id="saveBatchBtn" onclick="saveCurrentBatch()">SaglabƒÅt izvƒìli</button>
    <button class="btn btn-reply" id="commentBtn" onclick="openCommentModal()" disabled>KomentƒÅri</button>
    <button class="btn btn-activity" onclick="location.href='/mobile-activity.html'">Dienas darbƒ´bas</button>
</div>

<div id="animalModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); overflow-y:auto;">
    <div class="modal-content">
        <span class="close" onclick="closeAnimalModal()" style="float:right; font-size:2rem; cursor:pointer; color:#aaa;">√ó</span>
        <h2 id="modalAnimalName" style="margin:0 0 12px; font-size:1.6rem; color:var(--primary-dark);"></h2>
        <p style="margin:8px 0;"><strong>Sprosts:</strong> <span id="modalCage"></span></p>
        <div class="last-actions" style="background:var(--bg-alt); padding:12px; border-radius:12px; margin:16px 0;">
            <p style="margin:6px 0;"><strong>PƒìdƒìjƒÅ baro≈°ana:</strong> <span id="lastFed">-</span></p>
            <p style="margin:6px 0;"><strong>PƒìdƒìjƒÅ ≈´dens mai≈Üa:</strong> <span id="lastWater">-</span></p>
            <p style="margin:6px 0;"><strong>PƒìdƒìjƒÅ kop≈°ana:</strong> <span id="lastClean">-</span></p>
        </div>
        <h3>KomentƒÅri</h3>
        <div id="modalComments" style="max-height:200px; overflow-y:auto; margin:10px 0; padding:8px; background:var(--bg-alt); border-radius:8px;"></div>
        <div style="margin-top:10px; display:flex; gap:5px; position:sticky; bottom:0; background:var(--bg-alt); padding:10px 0; border-top:1px solid #eee;">
            <input type="text" id="modalCommentInput" placeholder="Pievienot komentƒÅru..." style="flex:1; padding:10px; border:1px solid #ccc; border-radius:8px;" />
            <button onclick="submitModalComment()" class="btn btn-small">S≈´tƒ´t</button>
            <button onclick="cancelModalReply()" id="cancelModalReplyBtn" class="btn btn-cancel btn-small" style="display:none; padding:6px 12px;">Atcelt</button>
        </div>
        <h3>PƒìdƒìjƒÅs 7 dienas</h3>
        <div id="actionHistory" style="background:var(--bg-alt); padding:12px; border-radius:12px; font-size:0.95rem;"></div>
    </div>
</div>

<script>
    // ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà VARIABLES + GLOBAL SCROLL FIX ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
    let currentUser = null;
    let selectedTaskId = null;
    let currentModalAnimalId = null;
    let modalReplyTo = null;
    let userData = null;
    const animalBatches = new Map();
    let tasksData = [];

    let GLOBAL_SCROLL = 0;
    window.addEventListener('scroll', () => GLOBAL_SCROLL = window.scrollY);
    if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

    // ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà USER INIT ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
    fetch('/api/user', { credentials: 'include' })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(user => {
            currentUser = user; userData = user;
            document.getElementById('mobile-username').textContent = user.username;
            updateDate(); loadTasksForToday(); initTheme();
            if (user.role === 'VeterinƒÅrƒÅrsta asistents') {
                document.getElementById('addAnimalContainer').style.display = 'block';
            }
        })
        .catch(() => location.href = '/login.html');

    // ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà THEME ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
    function initTheme() {
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const isDark = saved === 'dark' || (!saved && prefersDark);
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
        document.getElementById('themeCheckbox').checked = isDark;
    }
    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme') || 'light';
        const newTheme = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        document.getElementById('themeCheckbox').checked = (newTheme === 'dark');
    }

    // ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà DATE ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
    function updateDate() {
        const today = new Date();
        const days = ['Svƒìtdiena', 'Pirmdiena', 'Otrdiena', 'Tre≈°diena', 'Ceturtdiena', 'Piektdiena', 'Sestdiena'];
        document.getElementById('mobile-date').textContent = `${days[today.getDay()]} ${today.toLocaleDateString('lv-LV')}`;
    }

    // ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà LOAD TASKS ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
    function loadTasksForToday() {
        const container = document.getElementById('mobile-tasks');
        container.innerHTML = '<div class="loading">IelƒÅdƒì uzdevumus...</div>';

        const prevScroll = GLOBAL_SCROLL;
        const prevSelected = selectedTaskId;

        fetch('/api/mobile-tasks', { credentials: 'include' })
            .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
            .then(mobileData => {
                let roleTasks = []; let substitute = '';
                if (Array.isArray(mobileData)) {
                    roleTasks = mobileData.map(t => ({ ...t, id: Number(t.id) }));
                } else if (mobileData && mobileData.tasks) {
                    roleTasks = mobileData.tasks.map(t => ({ ...t, id: Number(t.id) }));
                    substitute = mobileData.substitute || '';
                }
                return Promise.all([
                    fetch('/api/today-actions', { credentials: 'include' }).then(r => r.json()),
                    fetch('/api/completed-today', { credentials: 'include' }).then(r => r.json()),
                    Promise.resolve(roleTasks),
                    Promise.resolve(substitute)
                ]);
            })
            .then(([actions, completedToday, roleTasks, substitute]) => {
                const grouped = {};
                actions.forEach(a => {
                    const id = a.animal_id;
                    if (!grouped[id]) grouped[id] = { actions: [], users: new Set(), comment_count: a.comment_count || 0 };
                    grouped[id].actions.push(a.action);
                    grouped[id].users.add(a.username);
                });

                tasksData = roleTasks.map(task => {
                    const id = task.id;
                    const g = grouped[id] || { actions: [], users: new Set(), comment_count: 0 };
                    const isCompleted = completedToday.some(c => c.animal_id == id);
                    const completedBy = isCompleted ? Array.from(g.users).join(', ') : null;
                    return { ...task, actions: g.actions, comment_count: g.comment_count, completed: isCompleted, completed_by: completedBy };
                });

                renderTasksWithState(prevSelected, substitute);

                requestAnimationFrame(() => {
                    window.scrollTo(0, prevScroll);
                    setTimeout(() => window.scrollTo(0, prevScroll), 100);
                });

                document.getElementById('taskSearch').value = '';
                document.getElementById('taskResults').style.display = 'none';
            })
            .catch(err => {
                console.error('[mobile] Kƒº≈´da:', err);
                container.innerHTML = `<div class="error">Kƒº≈´da: ${err.message}<br><button onclick="loadTasksForToday()" class="btn btn-primary">Mƒìƒ£inƒÅt vƒìlreiz</button></div>`;
                requestAnimationFrame(() => window.scrollTo(0, GLOBAL_SCROLL));
            });
    }

    // ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà RENDER TASKS (fast local update) ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
    function renderTasksWithState(prevSelected = selectedTaskId, substitute = '') {
        const container = document.getElementById('mobile-tasks');
        const bannerMatch = container.innerHTML.match(/<div style="background:#.{6};.*<\/div>/) || [''];
        const bannerHTML = bannerMatch[0] || (substitute ? generateBanner(substitute) : '');

        let html = bannerHTML;

        if (tasksData.length === 0) {
            html += '<p style="text-align:center;color:#999;margin:40px;font-size:1.2rem;">Nav uzdevumu ≈°odien üò¥</p>';
        } else {
            html += tasksData.map(t => {
                const batch = animalBatches.get(t.id) || new Set();
                const allActions = [...(t.actions || []), ...Array.from(batch)];
                const displayActions = allActions.length > 0 ? allActions.join(', ') : '‚Äî';
                const completedClass = t.completed ? 'completed' : '';
                const isSelectedClass = t.id === prevSelected ? 'selected' : '';
                const commentBadge = t.comment_count > 0 ? `<span style="background:#d32f2f;color:white;padding:4px 8px;border-radius:12px;font-size:0.8rem;">${t.comment_count} üí¨</span>` : '';

                const iconHtml = `
                        <img src="/task-icons/${t.id}.png" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                             class="animal-icon" alt="${t.name}" loading="lazy">
                        <div class="animal-icon fallback" style="display:none;">üêæ</div>
                    `;

                if (t.completed) {
                    return `<div class="task-card ${completedClass} ${isSelectedClass}" onclick="selectTask(${t.id}, this)">
                            ${iconHtml}
                            <h4>${t.cage} ‚Äì ${t.name} ${commentBadge}</h4>
                            <p><strong>Darbƒ´bas:</strong> ${displayActions}</p>
                            <p><strong>Izpildƒ´ja:</strong> ${t.completed_by || '‚Äî'}</'}</p>
                            <em style="color:#4CAF50;font-weight:bold;font-size:1.3rem;">Izpildƒ´ts ‚úÖ</em>
                        </div>`;
                }

                return `<div class="task-card ${completedClass} ${isSelectedClass}" onclick="selectTask(${t.id}, this)">
                        ${iconHtml}
                        <h4>${t.cage} ‚Äì ${t.name} ${commentBadge}</h4>
                        <p><strong>Darbƒ´bas:</strong> ${displayActions}</p>
                        <div class="task-actions">
                            <button class="btn-small ${batch.has('b') ? 'marked' : ''}" onclick="event.stopPropagation(); markAction(${t.id}, 'b')">b</button>
                            <button class="btn-small ${batch.has('≈´') ? 'marked' : ''}" onclick="event.stopPropagation(); markAction(${t.id}, '≈´')">≈´</button>
                            <button class="btn-small ${batch.has('k') ? 'marked' : ''}" onclick="event.stopPropagation(); markAction(${t.id}, 'k')">k</button>
                        </div>
                    </div>`;
            }).join('');
        }

        container.innerHTML = html;

        if (prevSelected) {
            selectedTaskId = prevSelected;
            const card = document.querySelector(`.task-card[onclick*="selectTask(${prevSelected}"`);
            if (card) card.classList.add('selected');
        }

        updateFloatingButtons();
    }

    function generateBanner(substitute) {
        const isReplaced = substitute.includes('Aizvieto≈°ana');
        const color = isReplaced ? '#d32f2f' : '#2e7d32';
        const bg = isReplaced ? '#ffebee' : '#e8f5e9';
        const border = isReplaced ? '#ffcdd2' : '#c8e6c9';
        const icon = isReplaced ? '‚ö†Ô∏è AIZVIETO≈†ANA!' : 'üîÑ Aizvieto≈°ana';
        return `<div style="background:${bg};padding:18px;border-radius:16px;margin:16px;border:3px solid ${border};box-shadow:0 6px 16px rgba(0,0,0,0.2);text-align:center;font-weight:bold;color:${color};font-size:1.2rem;">${icon} ${substitute}</div>`;
    }

    // ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà MARK ACTION (fast) ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
    function markAction(id, action) {
        let actions = animalBatches.get(id) || new Set();
        if (actions.has(action)) actions.delete(action);
        else actions.add(action);
        if (actions.size === 0) animalBatches.delete(id);
        else animalBatches.set(id, actions);
        renderTasksWithState();
    }

    // ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà SELECTION & BUTTONS ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
    function selectTask(id, el) {
        selectedTaskId = id;
        currentModalAnimalId = id;
        document.querySelectorAll('.task-card').forEach(card => card.classList.remove('selected'));
        el.classList.add('selected');
        updateFloatingButtons();
    }

    function updateFloatingButtons() {
        const hasSelection = !!selectedTaskId;
        const task = tasksData.find(t => t.id === selectedTaskId);
        const isCompleted = task?.completed;
        const batchSize = (animalBatches.get(selectedTaskId) || new Set()).size;

        document.getElementById('saveBatchBtn').style.display = hasSelection && batchSize > 0 && !isCompleted ? 'block' : 'none';
        document.getElementById('completeBtn').disabled = !hasSelection || isCompleted;
        document.getElementById('cancelBtn').disabled = !hasSelection || !isCompleted;
        document.getElementById('commentBtn').disabled = !hasSelection;
    }

    // ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà SAVE / COMPLETE / CANCEL ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
    async function saveCurrentBatch() {
        if (!selectedTaskId) return;
        const actions = Array.from(animalBatches.get(selectedTaskId) || []);
        if (actions.length === 0) return;

        const btn = document.getElementById('saveBatchBtn');
        btn.disabled = true; btn.textContent = 'S≈´ta...';
        GLOBAL_SCROLL = window.scrollY;

        try {
            await fetch('/api/mark-actions', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ animal_id: selectedTaskId, actions }) });
            animalBatches.delete(selectedTaskId);
            await loadTasksForToday();
            btn.disabled = false; btn.textContent = 'SaglabƒÅt izvƒìli'; btn.style.display = 'none';
        } catch (err) {
            console.error('Kƒº≈´da saglabƒÅjot:', err);
            btn.disabled = false; btn.textContent = 'SaglabƒÅt izvƒìli';
            alert('NeizdevƒÅs saglabƒÅt!');
        }
    }

    async function completeSelected() {
        if (!selectedTaskId) return alert('Izvƒìlies uzdevumu!');
        const batch = animalBatches.get(selectedTaskId);
        const actions = batch ? Array.from(batch) : [];
        GLOBAL_SCROLL = window.scrollY;

        try {
            if (actions.length > 0) {
                await fetch('/api/mark-actions', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ animal_id: selectedTaskId, actions }) });
                animalBatches.delete(selectedTaskId);
            }
            await fetch('/api/complete-task', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ animal_id: selectedTaskId }) });
            await loadTasksForToday();
            selectedTaskId = null; updateFloatingButtons();
        } catch (err) {
            console.error('Kƒº≈´da apstiprinot:', err); alert('NeizdevƒÅs apstiprinƒÅt!');
        }
    }

    async function cancelSelected() {
        if (!selectedTaskId) return alert('Izvƒìlies izpildƒ´to uzdevumu!');
        GLOBAL_SCROLL = window.scrollY;

        try {
            await fetch('/api/cancel-task', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ animal_id: selectedTaskId }) });
            await loadTasksForToday();
            selectedTaskId = null; updateFloatingButtons();
        } catch (err) {
            console.error('Kƒº≈´da atceƒºot:', err); alert('NeizdevƒÅs atcelt!');
        }
    }

    // ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà MODAL & COMMENTS ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
    function openCommentModal() {
        if (!selectedTaskId) return;
        openAnimalModal(selectedTaskId);
    }

    async function openAnimalModal(animalId) {
        if (!animalId) return;
        currentModalAnimalId = animalId;
        modalReplyTo = null;
        document.getElementById('cancelModalReplyBtn').style.display = 'none';
        document.getElementById('modalCommentInput').placeholder = 'Pievienot komentƒÅru...';

        const task = tasksData.find(t => t.id == animalId);
        if (!task) return;
        document.getElementById('modalAnimalName').textContent = task.name;
        document.getElementById('modalCage').textContent = task.cage;

        try {
            const res = await fetch(`/api/animal-history/${animalId}`, { credentials: 'include' });
            const history = await res.json();
            const last = { b: '-', ≈´: '-', k: '-' };
            const historyDiv = document.getElementById('actionHistory');
            historyDiv.innerHTML = history.length ? '' : '<p>Nav darbƒ´bu pƒìdƒìjo 7 dienu laikƒÅ.</p>';
            history.forEach(h => {
                if (!last[h.action] || h.date > last[h.action]) last[h.action] = h.date;
                const p = document.createElement('p');
                p.innerHTML = `<strong>${h.date}:</strong> ${h.action} <em>(by ${h.username})</em>`;
                historyDiv.appendChild(p);
            });
            document.getElementById('lastFed').textContent = last.b || '-';
            document.getElementById('lastWater').textContent = last.≈´ || '-';
            document.getElementById('lastClean').textContent = last.k || '-';
        } catch (e) { console.error(e); }

        loadModalComments(animalId);
        document.getElementById('animalModal').style.display = 'block';
    }

    function closeAnimalModal() {
        document.getElementById('animalModal').style.display = 'none';
    }

    function buildCommentTree(comments) {
        const map = new Map();
        const roots = [];
        comments.forEach(c => map.set(c.id, { ...c, children: [] }));
        comments.forEach(c => {
            if (c.parent_id === 0 || c.parent_id == null) roots.push(map.get(c.id));
            else {
                const parent = map.get(c.parent_id);
                if (parent) parent.children.push(map.get(c.id));
            }
        });
        return roots;
    }

    function renderCommentTree(container, comments, depth = 0) {
        comments.forEach(c => {
            const div = document.createElement('div');
            div.style.marginLeft = `${depth * 32}px`;
            div.style.padding = '12px';
            div.style.margin = '8px 0';
            div.style.borderRadius = '12px';
            div.style.background = c.resolved ? '#e8f5e9' : '#fff3e0';
            div.style.borderLeft = `4px solid ${c.resolved ? '#4caf50' : '#ff9800'}`;
            const time = new Date(c.timestamp).toLocaleString('lv-LV', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            const replyBtn = `<button onclick="setModalReply(${c.id})" style="background:none;border:none;color:#1976d2;cursor:pointer;font-size:12px;">Atbildƒìt</button>`;
            const resolveBtn = ['Admin', 'Zoologs'].includes(userData?.role) && !c.resolved ? `<button onclick="resolveModalComment(${c.id})" style="margin-left:8px;background:#4caf50;color:white;border:none;padding:4px 8px;border-radius:8px;font-size:11px;cursor:pointer;">AtrisinƒÅts</button>` : '';
            const replyTo = c.parent_id > 0 && c.parent_user ? `<span style="color:#666;font-size:11px;margin-left:6px;">‚Üí @${escapeHtml(c.parent_user)}</span>` : '';
            div.innerHTML = `
                    <div style="font-weight:600;">${escapeHtml(c.user)}${replyTo} <small style="color:#666;font-size:11px;">${time}</small></div>
                    <p style="margin:6px 0; line-height:1.5;">${escapeHtml(c.comment)}</p>
                    <div style="margin-top:8px;">${replyBtn} ${resolveBtn}</div>
                `;
            container.appendChild(div);
            if (c.children?.length) renderCommentTree(container, c.children, depth + 1);
        });
    }

    function loadModalComments(animalId) {
        const container = document.getElementById('modalComments');
        container.innerHTML = '<p style="text-align:center; color:#666;">IelƒÅdƒì...</p>';
        fetch(`/api/comments/${animalId}`, { credentials: 'include' })
            .then(r => r.json())
            .then(comments => {
                container.innerHTML = '';
                if (comments.length === 0) {
                    container.innerHTML = '<p style="color:#888;font-style:italic; text-align:center;">Nav komentƒÅru</p>';
                    return;
                }
                const tree = buildCommentTree(comments);
                renderCommentTree(container, tree, 0);
            })
            .catch(() => container.innerHTML = '<p style="color:red;">Kƒº≈´da ielƒÅdƒìjot komentƒÅrus</p>');
    }

    function setModalReply(parentId) {
        modalReplyTo = parentId;
        const input = document.getElementById('modalCommentInput');
        const cancelBtn = document.getElementById('cancelModalReplyBtn');
        input.placeholder = 'Atbilde uz komentƒÅru...';
        input.focus();
        cancelBtn.style.display = 'inline-block';
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function cancelModalReply() {
        modalReplyTo = null;
        const input = document.getElementById('modalCommentInput');
        const cancelBtn = document.getElementById('cancelModalReplyBtn');
        input.placeholder = 'Pievienot komentƒÅru...';
        cancelBtn.style.display = 'none';
    }

    function submitModalComment() {
        const input = document.getElementById('modalCommentInput');
        const text = input.value.trim();
        if (!text || !currentModalAnimalId) return;
        const payload = { animal_id: currentModalAnimalId, comment: text };
        if (modalReplyTo) payload.parent_id = modalReplyTo;
        fetch('/api/add-comment', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(() => {
                input.value = '';
                modalReplyTo = null;
                cancelModalReply();
                loadModalComments(currentModalAnimalId);
                loadTasksForToday();
            })
            .catch(() => alert('Kƒº≈´da s≈´tot komentƒÅru'));
    }

    function resolveModalComment(id) {
        fetch('/api/resolve-comment', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ comment_id: id }) })
            .then(() => loadModalComments(currentModalAnimalId));
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function logout() {
        fetch('/logout', { credentials: 'include' }).then(() => location.href = '/login.html');
    }

    window.onclick = e => {
        if (e.target === document.getElementById('animalModal')) closeAnimalModal();
    };

    // ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà SEARCH ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
    function filterTasks() {
        const query = document.getElementById('taskSearch').value.toLowerCase().trim();
        const resultsDiv = document.getElementById('taskResults');
        resultsDiv.innerHTML = '';
        if (!query) {
            resultsDiv.style.display = 'none';
            return;
        }
        const matches = tasksData.filter(t => t.cage.toLowerCase().includes(query) || t.name.toLowerCase().includes(query));
        if (matches.length === 0) {
            resultsDiv.innerHTML = '<div class="no-results">‚Äî Nav rezultƒÅtu ‚Äî</div>';
            resultsDiv.style.display = 'block';
            return;
        }
        matches.forEach(task => {
            const div = document.createElement('div');
            div.className = 'search-result-item';
            div.textContent = `${task.cage} ‚Äì ${task.name}`;
            div.onclick = (e) => { e.stopPropagation(); selectAndScroll(task.id); };
            resultsDiv.appendChild(div);
        });
        resultsDiv.style.display = 'block';
    }

    function selectAndScroll(id) {
        selectedTaskId = id;
        currentModalAnimalId = id;
        renderTasksWithState();
        const card = document.querySelector(`.task-card[onclick*="selectTask(${id}"`);
        if (card) {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            card.style.animation = 'pulse 0.6s ease';
        }
        document.getElementById('taskSearch').value = '';
        document.getElementById('taskResults').style.display = 'none';
        updateFloatingButtons();
    }

    document.getElementById('taskSearch').addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const first = document.querySelector('#taskResults .search-result-item');
            if (first) first.click();
        }
        if (e.key === 'Escape') {
            document.getElementById('taskSearch').value = '';
            document.getElementById('taskResults').style.display = 'none';
        }
    });

    document.addEventListener('click', e => {
        if (!e.target.closest('#taskSearch') && !e.target.closest('#taskResults')) {
            document.getElementById('taskResults').style.display = 'none';
        }
    });
</script>
</body>
</html>